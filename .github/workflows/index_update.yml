name: 推送仓库更新

on:
  workflow_dispatch:

jobs:
  build-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout dev branch
      uses: actions/checkout@v4
      with:
        ref: dev
        fetch-depth: 0

    - name: 安装 libgit2 开发包
      run: sudo apt-get update && sudo apt-get install -y libgit2-dev

    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: 安装依赖
      run: pip install -r requirements.txt

    - name: 生成 index.json
      run: python gen_index.py

    - name: 备份 index.json
      run: |
        cp index.json /tmp/index.json
        rm index.json

    - name: 合并 dev 到 main 并提交
      env:
        TZ: Asia/Shanghai
      run: |
        set -e

        git config user.name  "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git fetch origin main

        git switch main

        git merge --no-ff --no-commit origin/dev

        cp /tmp/index.json ./index.json
        git add index.json

        if git ls-files -u | grep .; then
          for f in $(git ls-files -u | cut -f2 | sort -u); do
            git checkout origin/dev -- "$f" || true
            git add "$f" || true
          done
        fi

        if git diff --cached --quiet; then
          echo "Nothing to commit, workflow ends."
          exit 0
        fi

        COMMIT_DATE=$(date +'%Y/%m/%d')
        git commit -m "Hachimi 简体中文仓库更新 ${COMMIT_DATE}"

        git push origin main
